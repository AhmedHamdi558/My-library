<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>مكتبتي</title>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg:         #0d0b08;
      --surface:    #161209;
      --card:       #1e1810;
      --gold:       #c9a84c;
      --gold-light: #e8c97a;
      --gold-dim:   rgba(201,168,76,0.13);
      --cream:      #f0e6cc;
      --muted:      #7a6a50;
      --border:     #2e2618;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; }

    body {
      background: var(--bg);
      color: var(--cream);
      font-family: 'Tajawal', sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
    }

    body::after {
      content: '';
      position: fixed; inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 9000;
    }

    /* ─── HEADER ─── */
    header {
      position: relative;
      text-align: center;
      padding: 70px 24px 50px;
      border-bottom: 1px solid var(--border);
      overflow: hidden;
    }

    header::before {
      content: '';
      position: absolute; inset: 0;
      background: radial-gradient(ellipse 80% 60% at 50% 0%, rgba(201,168,76,0.07) 0%, transparent 70%);
      pointer-events: none;
    }

    .ornament {
      font-family: 'Amiri', serif;
      color: var(--gold);
      font-size: 1.3rem;
      letter-spacing: 10px;
      opacity: 0.6;
      display: block;
      margin-bottom: 18px;
      animation: fadeDown 0.9s ease both;
    }

    h1 {
      font-family: 'Amiri', serif;
      font-size: clamp(2.8rem, 7vw, 5rem);
      font-weight: 700;
      color: var(--gold-light);
      letter-spacing: 3px;
      line-height: 1;
      animation: fadeDown 0.9s 0.12s ease both;
    }

    .subtitle {
      margin-top: 14px;
      font-size: 0.88rem;
      color: var(--muted);
      letter-spacing: 3px;
      font-weight: 300;
      animation: fadeDown 0.9s 0.24s ease both;
    }

    /* ─── CONTROLS ─── */
    .controls {
      max-width: 960px;
      margin: 40px auto 0;
      padding: 0 24px;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      animation: fadeUp 0.8s 0.3s ease both;
    }

    .search-wrap {
      flex: 1;
      min-width: 200px;
      position: relative;
    }

    .search-wrap svg {
      position: absolute;
      left: 14px; top: 50%;
      transform: translateY(-50%);
      width: 16px; height: 16px;
      stroke: var(--muted); fill: none;
      stroke-width: 2; stroke-linecap: round;
      pointer-events: none;
    }

    .search-wrap input {
      width: 100%;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--cream);
      padding: 13px 18px 13px 44px;
      border-radius: 3px;
      font-family: 'Tajawal', sans-serif;
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.25s, box-shadow 0.25s;
    }

    .search-wrap input::placeholder { color: var(--muted); }
    .search-wrap input:focus {
      border-color: var(--gold);
      box-shadow: 0 0 0 3px rgba(201,168,76,0.08);
    }

    /* زر المفضلة */
    .fav-filter-btn {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 13px 20px;
      border-radius: 3px;
      font-family: 'Tajawal', sans-serif;
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 7px;
      transition: all 0.22s;
      white-space: nowrap;
    }

    .fav-filter-btn svg {
      width: 15px; height: 15px;
      fill: none; stroke: currentColor;
      stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
      transition: all 0.22s;
    }

    .fav-filter-btn:hover { border-color: var(--gold); color: var(--gold); }

    .fav-filter-btn.active {
      background: var(--gold-dim);
      border-color: var(--gold);
      color: var(--gold);
    }

    .fav-filter-btn.active svg { fill: var(--gold); stroke: var(--gold); }

    /* ─── STATS ─── */
    .stats {
      max-width: 960px;
      margin: 18px auto 0;
      padding: 0 24px;
      color: var(--muted);
      font-size: 0.82rem;
      letter-spacing: 1px;
      display: none;
    }

    .stats strong { color: var(--gold); margin: 0 2px; }

    /* ─── GRID ─── */
    .grid {
      max-width: 960px;
      margin: 26px auto 0;
      padding: 0 24px 80px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(215px, 1fr));
      gap: 22px;
    }

    /* ─── CARD ─── */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 4px;
      overflow: hidden;
      transition: transform 0.28s, box-shadow 0.28s, border-color 0.28s;
      animation: fadeUp 0.5s ease both;
      position: relative;
    }

    .card:hover {
      transform: translateY(-5px);
      border-color: var(--gold);
      box-shadow: 0 18px 45px rgba(0,0,0,0.55);
    }

    /* ─── زر الإعجاب ─── */
    .card-like {
      position: absolute;
      top: 10px; left: 10px;
      z-index: 10;
      width: 34px; height: 34px;
      border-radius: 50%;
      background: rgba(13,11,8,0.65);
      backdrop-filter: blur(4px);
      border: 1px solid rgba(255,255,255,0.08);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.22s;
    }

    .card-like:hover {
      background: rgba(201,168,76,0.18);
      border-color: var(--gold);
      transform: scale(1.12);
    }

    .card-like svg {
      width: 16px; height: 16px;
      fill: none;
      stroke: var(--muted);
      stroke-width: 2;
      stroke-linecap: round; stroke-linejoin: round;
      transition: all 0.22s;
    }

    .card-like.liked svg { fill: var(--gold); stroke: var(--gold); }

    @keyframes heartPop {
      0%   { transform: scale(1); }
      40%  { transform: scale(1.38); }
      70%  { transform: scale(0.88); }
      100% { transform: scale(1); }
    }

    .card-like.pop { animation: heartPop 0.35s ease; }

    /* ─── غلاف الكتاب ─── */
    .card-cover {
      height: 190px;
      position: relative;
      overflow: hidden;
    }

    .card-cover img {
      width: 100%; height: 100%;
      object-fit: cover;
      display: block;
      transition: transform 0.38s;
    }

    .card:hover .card-cover img { transform: scale(1.05); }

    .card-cover-fallback {
      width: 100%; height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .card-cover-fallback::before {
      content: '';
      position: absolute; inset: 0;
      background-image: repeating-linear-gradient(
        45deg, transparent, transparent 12px,
        rgba(255,255,255,0.025) 12px, rgba(255,255,255,0.025) 13px
      );
    }

    .fallback-title {
      font-family: 'Amiri', serif;
      font-size: 1.25rem;
      color: rgba(255,255,255,0.88);
      text-align: center;
      padding: 18px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.7);
      position: relative; z-index: 1;
      line-height: 1.5;
    }

    .fallback-orn {
      position: absolute;
      bottom: 10px; left: 0; right: 0;
      text-align: center;
      font-family: 'Amiri', serif;
      color: var(--gold);
      opacity: 0.4; font-size: 1rem; z-index: 1;
    }

    /* ─── جسم البطاقة ─── */
    .card-body { padding: 16px 18px 18px; }

    .card-title {
      font-family: 'Amiri', serif;
      font-size: 1.12rem;
      color: var(--cream);
      line-height: 1.45;
      margin-bottom: 7px;
    }

    .card-desc {
      color: var(--muted);
      font-size: 0.83rem;
      line-height: 1.75;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* ─── أزرار ─── */
    .card-actions {
      display: flex;
      gap: 9px;
      margin-top: 15px;
      padding-top: 14px;
      border-top: 1px solid var(--border);
    }

    .btn {
      flex: 1;
      padding: 9px 8px;
      border: none;
      border-radius: 3px;
      font-family: 'Tajawal', sans-serif;
      font-size: 0.84rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      transition: all 0.2s;
      text-decoration: none;
    }

    .btn svg {
      width: 13px; height: 13px;
      stroke: currentColor; fill: none;
      stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
      flex-shrink: 0;
    }

    .btn-read { background: var(--gold); color: #0d0b08; font-weight: 700; }
    .btn-read:hover { background: var(--gold-light); }

    .btn-dl { background: transparent; color: var(--muted); border: 1px solid var(--border); }
    .btn-dl:hover { color: var(--cream); border-color: var(--muted); }

    /* ─── MODAL ─── */
    .modal {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.93);
      z-index: 5000;
      display: flex; flex-direction: column;
      opacity: 0; pointer-events: none;
      transition: opacity 0.28s;
    }

    .modal.open { opacity: 1; pointer-events: all; }

    .modal-bar {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 22px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }

    .modal-bar-title {
      font-family: 'Amiri', serif;
      font-size: 1.15rem;
      color: var(--gold-light);
    }

    .modal-bar-actions { display: flex; gap: 10px; }

    .modal-btn {
      background: none;
      border: 1px solid var(--border);
      color: var(--cream);
      padding: 7px 16px;
      border-radius: 3px;
      font-family: 'Tajawal', sans-serif;
      font-size: 0.88rem;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .modal-btn svg {
      width: 14px; height: 14px;
      stroke: currentColor; fill: none;
      stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
    }

    .modal-btn:hover { background: rgba(255,255,255,0.06); }
    .modal-btn.gold { background: var(--gold); color: #0d0b08; border-color: var(--gold); font-weight: 700; }
    .modal-btn.gold:hover { background: var(--gold-light); }

    .modal-body { flex: 1; overflow: hidden; }
    .modal-body iframe { width: 100%; height: 100%; border: none; display: block; }

    /* ─── EMPTY ─── */
    .empty {
      grid-column: 1 / -1;
      text-align: center;
      padding: 70px 20px;
    }

    .empty svg {
      width: 54px; height: 54px;
      stroke: var(--muted); fill: none;
      stroke-width: 1.2; stroke-linecap: round;
      opacity: 0.28; margin: 0 auto 16px; display: block;
    }

    .empty h3 { font-family: 'Amiri', serif; font-size: 1.4rem; color: var(--muted); margin-bottom: 6px; }
    .empty p  { color: var(--muted); font-size: 0.86rem; opacity: 0.65; }

    /* ─── LOADING ─── */
    .loading {
      grid-column: 1 / -1;
      text-align: center;
      padding: 80px;
      color: var(--muted);
      font-size: 0.88rem;
      letter-spacing: 2px;
    }

    .loading::after {
      content: '';
      display: block;
      width: 34px; height: 34px;
      border: 2px solid var(--border);
      border-top-color: var(--gold);
      border-radius: 50%;
      margin: 18px auto 0;
      animation: spin 0.9s linear infinite;
    }

    /* ─── ERROR ─── */
    .error-msg {
      grid-column: 1 / -1;
      text-align: center;
      padding: 60px 24px;
      color: #c97a6a;
      font-size: 0.9rem;
      line-height: 1.8;
    }

    .error-msg code {
      display: block; margin-top: 12px;
      font-size: 0.78rem; color: var(--muted);
      font-family: monospace;
      background: var(--surface);
      padding: 10px 16px; border-radius: 3px;
      border: 1px solid var(--border);
    }

    /* ─── FOOTER ─── */
    footer {
      text-align: center;
      padding: 24px;
      border-top: 1px solid var(--border);
      color: var(--muted);
      font-size: 0.78rem;
      letter-spacing: 2px;
    }

    footer span { color: var(--gold); }

    /* ─── ANIMATIONS ─── */
    @keyframes fadeDown {
      from { opacity: 0; transform: translateY(-16px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(16px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ─── SCROLLBAR ─── */
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--gold); }

    @media (max-width: 520px) {
      .controls { flex-direction: column; }
      .fav-filter-btn { width: 100%; justify-content: center; }
    }
  </style>
</head>
<body>

<header>
  <span class="ornament">&#10022; &#10087; &#10022;</span>
  <h1>مكتبتي</h1>
  <p class="subtitle">كتب &middot; روايات &middot; قصص</p>
</header>

<div class="controls">
  <div class="search-wrap">
    <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    <input type="text" id="searchInput" placeholder="ابحث عن كتاب..." oninput="applyFilters()" />
  </div>
  <button class="fav-filter-btn" id="favBtn" onclick="toggleFavFilter()">
    <svg viewBox="0 0 24 24">
      <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
    </svg>
    المفضلة
  </button>
</div>

<div class="stats" id="statsBar">
  <strong id="countShown">0</strong> كتاب
</div>

<div class="grid" id="booksGrid">
  <div class="loading">جاري التحميل</div>
</div>

<div class="modal" id="modal">
  <div class="modal-bar">
    <div class="modal-bar-title" id="modalTitle"></div>
    <div class="modal-bar-actions">
      <a href="#" id="modalDl" class="modal-btn gold" download>
        <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        تنزيل
      </a>
      <button class="modal-btn" onclick="closeModal()">
        <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        إغلاق
      </button>
    </div>
  </div>
  <div class="modal-body">
    <iframe id="modalFrame" src="" allowfullscreen></iframe>
  </div>
</div>

<footer>&#10022; <span>مكتبتي الشخصية</span> &#10022; جميع الحقوق محفوظة</footer>

<script>
  // ──────────────────────────────────────────
  //  الإعجابات تُحفظ في localStorage للأبد
  // ──────────────────────────────────────────
  const STORAGE_KEY  = 'library_favorites_v1';
  const COVER_COLORS = [
    '#5c1a1a','#1a3058','#2a1a5c','#1a4a30',
    '#5c3a10','#3a1050','#105050','#4a1040',
    '#4a2810','#1a4a4a','#501028','#283050'
  ];

  let ALL_BOOKS   = [];
  let showFavOnly = false;

  /* ── localStorage helpers ── */
  function getFavorites() {
    try { return new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]')); }
    catch { return new Set(); }
  }

  function saveFavorites(set) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify([...set]));
  }

  /* ── تحميل engine.json ── */
  async function loadLibrary() {
    try {
      const res = await fetch('Files/engine.json');
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data  = await res.json();
      const books = Array.isArray(data) ? data : (data.books || []);

      // قراءة ملفات الوصف .txt بالتوازي
      ALL_BOOKS = await Promise.all(books.map(async (book, i) => {
        book._id = book.id || `book_${i}`;
        if (book.descFile) {
          try {
            const r = await fetch(book.descFile);
            book.description = r.ok ? (await r.text()).trim() : '';
          } catch { book.description = ''; }
        }
        return book;
      }));

      applyFilters();
    } catch (err) {
      document.getElementById('booksGrid').innerHTML = `
        <div class="error-msg">
          تعذّر تحميل قائمة الكتب، تأكد من وجود الملف.<br>
          <code>Files/engine.json</code>
          <br><small style="opacity:.5">${err.message}</small>
        </div>`;
    }
  }

  /* ── تصفية وعرض ── */
  function applyFilters() {
    const q    = document.getElementById('searchInput').value.trim().toLowerCase();
    const favs = getFavorites();

    const list = ALL_BOOKS.filter(b => {
      const matchFav = !showFavOnly || favs.has(b._id);
      const matchQ   = !q
        || (b.title       || '').toLowerCase().includes(q)
        || (b.description || '').toLowerCase().includes(q);
      return matchFav && matchQ;
    });

    renderBooks(list, favs);
    document.getElementById('countShown').textContent  = list.length;
    document.getElementById('statsBar').style.display  = '';
  }

  /* ── رسم البطاقات ── */
  function renderBooks(list, favs) {
    const grid = document.getElementById('booksGrid');

    if (list.length === 0) {
      grid.innerHTML = `
        <div class="empty">
          <svg viewBox="0 0 24 24">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
          </svg>
          <h3>${showFavOnly ? 'المفضلة فارغة' : 'لا توجد نتائج'}</h3>
          <p>${showFavOnly ? 'اضغط على القلب في أي كتاب لإضافته للمفضلة' : 'جرّب كلمة بحث مختلفة'}</p>
        </div>`;
      return;
    }

    grid.innerHTML = list.map((book, i) => {
      const color   = book.color || COVER_COLORS[i % COVER_COLORS.length];
      const delay   = (i % 6) * 0.06;
      const isLiked = favs.has(book._id);

      const coverHTML = book.image
        ? `<img src="${escA(book.image)}" alt="${escA(book.title)}" loading="lazy"
               onerror="this.parentElement.innerHTML=fallbackCover('${escJs(book.title)}','${color}')">`
        : fallbackCover(book.title, color);

      return `
        <div class="card" style="animation-delay:${delay}s">

          <button class="card-like ${isLiked ? 'liked' : ''}"
                  onclick="toggleLike(event,'${escJs(book._id)}')"
                  title="${isLiked ? 'إلغاء الإعجاب' : 'أعجبني'}">
            <svg viewBox="0 0 24 24">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
            </svg>
          </button>

          <div class="card-cover">${coverHTML}</div>

          <div class="card-body">
            <div class="card-title">${escH(book.title)}</div>
            ${book.description ? `<p class="card-desc">${escH(book.description)}</p>` : ''}
            <div class="card-actions">
              <button class="btn btn-read" onclick="openPDF('${escJs(book.pdf)}','${escJs(book.title)}')">
                <svg viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                قراءة
              </button>
              <a class="btn btn-dl" href="${escA(book.pdf)}" download>
                <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                تنزيل
              </a>
            </div>
          </div>
        </div>`;
    }).join('');
  }

  /* ── الإعجاب ── */
  function toggleLike(e, bookId) {
    e.stopPropagation();
    const btn  = e.currentTarget;
    const favs = getFavorites();

    if (favs.has(bookId)) {
      favs.delete(bookId);
      btn.classList.remove('liked');
    } else {
      favs.add(bookId);
      btn.classList.add('liked');
    }

    saveFavorites(favs);

    // نبضة
    btn.classList.remove('pop');
    void btn.offsetWidth;
    btn.classList.add('pop');

    // إذا فلتر المفضلة مفعّل، أعد الرسم
    if (showFavOnly) applyFilters();
  }

  /* ── فلتر المفضلة ── */
  function toggleFavFilter() {
    showFavOnly = !showFavOnly;
    document.getElementById('favBtn').classList.toggle('active', showFavOnly);
    applyFilters();
  }

  /* ── عارض PDF ── */
  function openPDF(src, title) {
    if (!src) return;
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalFrame').src         = src;
    document.getElementById('modalDl').href           = src;
    document.getElementById('modalDl').download       = title + '.pdf';
    document.getElementById('modal').classList.add('open');
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    document.getElementById('modal').classList.remove('open');
    document.getElementById('modalFrame').src = '';
    document.body.style.overflow = '';
  }

  /* ── غلاف بديل ── */
  function fallbackCover(title, color) {
    return `<div class="card-cover-fallback" style="background:linear-gradient(140deg,${color} 0%,#0d0b08 100%)">
      <div class="fallback-title">${escH(title)}</div>
      <div class="fallback-orn">&#10022; &#10087; &#10022;</div>
    </div>`;
  }

  /* ── escape helpers ── */
  function escH(s)  { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
  function escA(s)  { return escH(s); }
  function escJs(s) { return String(s||'').replace(/\\/g,'\\\\').replace(/'/g,"\\'"); }

  /* ── أحداث ── */
  document.getElementById('modal').addEventListener('click', e => {
    if (e.target === document.getElementById('modal')) closeModal();
  });

  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeModal();
  });

  /* ── بدء ── */
  loadLibrary();
</script>
</body>
</html>
